#!/bin/sh

# ステージ済みのファイルのうち、Deno対応のファイルのみ抽出
FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx|mjs|cjs)$')
if [ -z "$FILES" ]; then
	exit 0
fi
echo "$(echo $FILES | wc -w)個のファイルをチェックします"

# フォーマット適用
echo "フォーマットを適用中..."
deno fmt $FILES
if [ $? -ne 0 ]; then
	echo "Deno fmt failed. Please check your code."
	exit 1
fi
echo "フォーマット完了"

# フォーマット後のファイルを再ステージ
echo "$FILES" | xargs git add

# リントチェック
echo "Deno lintを実行中..."
deno lint $FILES
if [ $? -ne 0 ]; then
	echo "Deno lint check failed. Please fix lint errors."
	exit 1
fi
echo "Deno lintチェック完了"

exit 0